# Licensing Architecture

## Overview

Mingly uses offline-first license key validation with HMAC-SHA256 signatures. No external server is required for license checks — the app validates keys locally using a built-in verification key.

## Distribution Model

- **One binary** for all tiers (Free, Pro, Team, Enterprise)
- Downloads via [GitHub Releases](https://github.com/Baldri/mingly/releases)
- Auto-updates via `electron-updater` (GitHub provider)
- License key unlocks features in-app (feature-gating, not download-gating)

## License Key Format

```
MINGLY-{TIER}-{PAYLOAD}-{SIGNATURE}
```

Example: `MINGLY-PRO-A1B2C3D4E5F6-8A3F7B2E`

| Segment | Description |
|---------|-------------|
| `MINGLY` | Fixed prefix |
| `TIER` | `PRO`, `TEAM`, or `ENTERPRISE` |
| `PAYLOAD` | Random hex string (12+ chars) |
| `SIGNATURE` | HMAC-SHA256 of `MINGLY-{TIER}-{PAYLOAD}`, truncated to 8 hex chars |

## Validation Flow

1. **Format check** — Verify `MINGLY-{TIER}-{PAYLOAD}-{SIG}` structure
2. **HMAC signature check** — Compute expected HMAC, compare with key's last segment
3. **Legacy fallback** — Keys without valid HMAC accepted with 90-day grace period

```
Key entered
  |
  v
Format valid? --NO--> Error: invalid format
  |
  YES
  v
HMAC valid? --YES--> Activate (signed mode, no expiry)
  |
  NO
  v
Accept as legacy (90-day grace period)
```

## Tier Features

| Feature | Free | Pro | Team | Enterprise |
|---------|:----:|:---:|:----:|:----------:|
| Local models (Ollama) | Yes | Yes | Yes | Yes |
| Cloud APIs | - | Yes | Yes | Yes |
| Unlimited conversations | - | Yes | Yes | Yes |
| Auto-updates (install) | - | Yes | Yes | Yes |
| Team workspaces | - | - | Yes | Yes |
| RBAC & audit | - | - | Yes | Yes |

## Purchase Flow

1. User clicks "Upgrade" in Settings
2. Redirected to Stripe Payment Link (per tier)
3. Stripe processes payment
4. License key delivered via email (generated by admin CLI or Stripe webhook)
5. User enters key in Settings > Subscription > "Enter License Key"

## Key Generation (Admin)

```typescript
import { LicenseActivationService } from './license-activation'

// Generate a signed PRO key
const key = LicenseActivationService.generateKey('pro')
// → "MINGLY-PRO-A1B2C3D4E5F6-8A3F7B2E"

// Generate with custom payload
const key2 = LicenseActivationService.generateKey('team', 'CUSTOMLOAD')
// → "MINGLY-TEAM-CUSTOMLOAD-{HMAC}"
```

## Security Notes

- HMAC secret is embedded in the app binary (acceptable for current scale)
- Key sharing is a non-issue at indie/startup phase
- Legacy grace period allows migration from unsigned to signed keys
- No network requests required for validation
